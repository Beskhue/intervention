#!/usr/bin/env python3
"""Intervention learning entrypoints."""

from typing import Optional

import click
from pathlib import Path
from loguru import logger
import sys

import intervention.process


@click.group()
def cli():
    pass


@cli.command()
def manual():
    import intervention.run

    intervention.run.manual()


@cli.command()
@click.option(
    "-t",
    "--teacher-checkpoint",
    required=True,
    type=click.Path(exists=True, file_okay=True, dir_okay=False, readable=True),
    help=("The checkpoint to use for the teacher."),
)
@click.option(
    "-n",
    "--num_episodes",
    default=1,
    type=int,
    help="The number of episodes to collect. Terminated episodes also count.",
)
@click.option(
    "-d",
    "--directory",
    default=".",
    type=click.Path(
        exists=False, file_okay=False, dir_okay=True, writable=True, readable=True
    ),
    help=(
        "The directory to write the episodes to. This directory will contain a "
        "top-level file to which summary information is written. If the file exists, "
        "will be appended to. Per-episode data is written to their own subdirectories."
    ),
)
@click.option(
    "device_name",
    "--device",
    default="cuda",
    type=str,
    help=(
        "The device to run on. "
        "See torch's documentation on torch.device for more information."
    ),
)
def collect_teacher_examples(
    teacher_checkpoint: str, num_episodes: int, directory: str, device_name: str,
):
    """
    Collect examples of driving from a teacher agent.
    """
    import torch

    import intervention.run

    data_path = Path(directory)
    data_path.mkdir(parents=True, exist_ok=True)
    teacher_checkpoint_path = Path(teacher_checkpoint)

    intervention.process.torch_device = torch.device(device_name)

    intervention.run.collect_example_episodes(
        teacher_checkpoint, data_path=data_path, num_episodes=num_episodes,
    )


@cli.command()
@click.option(
    "-n",
    "--num_episodes",
    default=1,
    type=int,
    help="The number of episodes to collect. Terminated episodes also count.",
)
@click.option(
    "-d",
    "--directory",
    default=".",
    type=click.Path(
        exists=False, file_okay=False, dir_okay=True, writable=True, readable=True
    ),
    help=(
        "The directory to write the episodes to. This directory will contain a "
        "top-level file to which summary information is written. If the file exists, "
        "will be appended to. Per-episode data is written to their own subdirectories."
    ),
)
def collect_on_policy(num_episodes: int, directory: str):
    """
    Collect student on-policy driving with interventions from a teacher.
    """
    import intervention.run

    data_path = Path(directory)
    data_path.mkdir(parents=True, exist_ok=True)

    intervention.run.collect_on_policy_episodes(
        data_path=data_path, num_episodes=num_episodes
    )


@cli.command()
def demo_image_agent():
    import intervention.run

    intervention.run.demo_image_agent()


@cli.command()
@click.option(
    "-d",
    "--dataset-directory",
    type=click.Path(
        exists=True, file_okay=False, dir_okay=True, writable=False, readable=True
    ),
    help="The directory of the dataset to train on.",
)
@click.option(
    "-o",
    "--output-directory",
    default=".",
    type=click.Path(
        exists=False, file_okay=False, dir_okay=True, writable=True, readable=True
    ),
    help=("The directory to write the output checkpoints to."),
)
@click.option(
    "-i",
    "--initial-checkpoint",
    required=False,
    type=click.Path(exists=True, file_okay=True, dir_okay=False, readable=True),
    help=("The checkpoint to resume training from."),
)
@click.option(
    "device_name",
    "--device",
    default="cuda",
    type=str,
    help=(
        "The device to run on. "
        "See torch's documentation on torch.device for more information."
    ),
)
def train_test(
    dataset_directory: str,
    output_directory: str,
    initial_checkpoint: Optional[str],
    device_name: str,
):
    import torch

    import intervention.train.train

    dataset_path = Path(dataset_directory)

    output_path = Path(output_directory)
    output_path.mkdir(parents=True, exist_ok=True)

    initial_checkpoint_path = Path(initial_checkpoint) if initial_checkpoint else None

    intervention.process.torch_device = torch.device(device_name)

    intervention.train.train.test(
        dataset_path, output_path, initial_checkpoint_path=initial_checkpoint_path,
    )


@cli.command()
@click.option(
    "-d",
    "--dataset-directory",
    type=click.Path(
        exists=True, file_okay=False, dir_okay=True, writable=False, readable=True
    ),
    help="The directory of the dataset to view",
)
def explore_off_policy_dataset(dataset_directory: str,):
    import intervention.run

    dataset_path = Path(dataset_directory)

    intervention.run.explore_off_policy_dataset(dataset_path)


if __name__ == "__main__":
    logger.remove(handler_id=0)  # Remove default handler.
    logger.add(
        sys.stderr,
        level="TRACE",
        format=(
            "<green>{time:YYYY-MM-DD HH:mm:ss.SSS}</green>"
            "| <red>{process.name: <10} {thread.name: <10}</red>"
            "| <level>{level: <8}</level>"
            "| <cyan>{name}</cyan>:<cyan>{function}</cyan>:<cyan>{line}</cyan>"
            "- <level>{message}</level>"
        ),
    )

    cli()
